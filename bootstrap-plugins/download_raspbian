#!/bin/bash

# download & mount raspbian image

RPI_DOWNLOAD_RASPBIAN_FLAVOR="${RPI_DOWNLOAD_RASPBIAN_FLAVOR:=lite}"
RPI_DOWNLOAD_RASPBIAN_URL="${RPI_DOWNLOAD_RASPBIAN_URL:="https://downloads.raspberrypi.org/raspbian_${RPI_DOWNLOAD_RASPBIAN_FLAVOR}_latest"}"


function rpi_download_raspbian_prerun() {
    true
}

function rpi_download_raspbian_run() {

    name="raspbian-${RPI_DOWNLOAD_RASPBIAN_FLAVOR}.img"

    warn "downloading ${RPI_DOWNLOAD_RASPBIAN_URL} ..."
    dest="${RPI_WORKDIR}/${name}"

    # already downloaded?
    if ! [ -f "${dest}" ] ; then
      tmpfile="$(TMPDIR=${RPI_TMPDIR} mktemp || error mktemp)"
      # download
      download_file "${RPI_DOWNLOAD_RASPBIAN_URL}" "${tmpfile}"
      # unzip
      warn "unzipping \"${tmpfile}\""
      unzip "${tmpfile}" || error unzip
      sync
      rm "${tmpfile}" || error rm
      mv *raspbian-*.img "${dest}" || error mv
    fi

    # mount image
    echo "setting up loopback for ${dest}"
    dev="$(loopback_setup "${dest}")" || error "loopback setup"
    mount_image "${dev}" || error "image mount"

    # set image filename globally
    RPI_IMG_NAME="${dest}"
}

function rpi_download_raspbian_postrun() {
    echo "cleaning up..."
    umount_image
    loopback_cleanup "${dev}"
}

