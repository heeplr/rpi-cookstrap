#!/bin/bash

# reduce power usage in default configuration


# ---------------------------------------------------------------------
function rpi_powersave_prerun() {
    load_plugin "systemctl"
    load_plugin "config"
}

function rpi_powersave_run() {
    local disable_services=(
        "avahi-daemon"
        "triggerhappy"
        "bluetooth"
        "hciuart"
        "bluetooth.target"
        "dbus"
        "keyboard-setup"
        "cryptsetup.target"
        "nfs-client.target"
        "apt-daily-upgrade.timer"
        "apt-daily.timer"
        "man-db.timer"
    )
    # prefix disable_services with "disable "
    RPI_SYSTEMCTL_CMDS="disable ${disable_services[*]}"
    rpi_systemctl_run || error "systemctl disable"

    # turn off unneeded things
    RPI_CONFIG_ADD=(
        "dtparam=audio=off"
        "disable_auto_turbo=1"
        "dtoverlay=disable-bluetooth"
        "dtparam=i2c_arm=off"
        "dtparam=i2s=off"
        "dtparam=spi=off"
        "start_x=0"
    )
    rpi_config_run || error "config.txt modification"

    # turn off HDMI
    run_on_boot "# turn off HDMI" || error "run_on_boot"
    run_on_boot "/usr/bin/tvservice -o" || error "run_on_boot"
    # turn on USB power saving
    run_on_boot "# usb power saving" || error "run_on_boot"
    run_on_boot "echo 'auto' > '/sys/bus/usb/devices/usb1/power/control'" "run_on_boot"
}

function rpi_powersave_description() {
    echo "configure image for optimized power usage"
}
